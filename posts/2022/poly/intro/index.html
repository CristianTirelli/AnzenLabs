<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Getting the hang of polyhedral compilation | Anzen Labs</title><meta name=keywords content><meta name=description content="The polyhedral model is an optimization and parallelization technique used to speed up the execution of loops. The main idea is to create a mathematical abstraction of a program and use it to exploit the target device&rsquo;s architecture through the design of sophisticated optimization heuristics. It&rsquo;s called polyhedral compilation, but modeling through polyhedra is neither required nor sufficient, in fact it is possible to obtain the same optimizations with other techniques."><meta name=author content><link rel=canonical href=https://anzenlabs.com/posts/2022/poly/intro/><link crossorigin=anonymous href=/assets/css/stylesheet.d7fb4cbf980fe688a21621b06a795933c4e6bb2d4070ec940667af1715d84af2.css integrity="sha256-1/tMv5gP5oiiFiGwanlZM8Tmuy1AcOyUBmevFxXYSvI=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://anzenlabs.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://anzenlabs.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://anzenlabs.com/favicon-32x32.png><link rel=apple-touch-icon href=https://anzenlabs.com/apple-touch-icon.png><link rel=mask-icon href=https://anzenlabs.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css integrity=sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js integrity=sha384-X/XCfMm41VSsqRNQgDerQczD69XqmjOOOwYQvr/uuC+j4OPoNhVgjdGFwhvN02Ja crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous onload=renderMathInElement(document.body)></script><meta property="og:title" content="Getting the hang of polyhedral compilation"><meta property="og:description" content="The polyhedral model is an optimization and parallelization technique used to speed up the execution of loops. The main idea is to create a mathematical abstraction of a program and use it to exploit the target device&rsquo;s architecture through the design of sophisticated optimization heuristics. It&rsquo;s called polyhedral compilation, but modeling through polyhedra is neither required nor sufficient, in fact it is possible to obtain the same optimizations with other techniques."><meta property="og:type" content="article"><meta property="og:url" content="https://anzenlabs.com/posts/2022/poly/intro/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-04-16T14:36:47+02:00"><meta property="article:modified_time" content="2022-04-16T14:36:47+02:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Getting the hang of polyhedral compilation"><meta name=twitter:description content="The polyhedral model is an optimization and parallelization technique used to speed up the execution of loops. The main idea is to create a mathematical abstraction of a program and use it to exploit the target device&rsquo;s architecture through the design of sophisticated optimization heuristics. It&rsquo;s called polyhedral compilation, but modeling through polyhedra is neither required nor sufficient, in fact it is possible to obtain the same optimizations with other techniques."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://anzenlabs.com/posts/"},{"@type":"ListItem","position":3,"name":"Getting the hang of polyhedral compilation","item":"https://anzenlabs.com/posts/2022/poly/intro/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Getting the hang of polyhedral compilation","name":"Getting the hang of polyhedral compilation","description":"The polyhedral model is an optimization and parallelization technique used to speed up the execution of loops. The main idea is to create a mathematical abstraction of a program and use it to exploit the target device\u0026rsquo;s architecture through the design of sophisticated optimization heuristics. It\u0026rsquo;s called polyhedral compilation, but modeling through polyhedra is neither required nor sufficient, in fact it is possible to obtain the same optimizations with other techniques.","keywords":[],"articleBody":"The polyhedral model is an optimization and parallelization technique used to speed up the execution of loops. The main idea is to create a mathematical abstraction of a program and use it to exploit the target device’s architecture through the design of sophisticated optimization heuristics. It’s called polyhedral compilation, but modeling through polyhedra is neither required nor sufficient, in fact it is possible to obtain the same optimizations with other techniques.\nCase study Before defining some common concepts, it’s probably better to provide a simple example that shows at least one use case of this technique.\nLet’s take the following code as example:\n1 2 3 4 for (int i = 0; i \u003c 5; i++) A[i] = 2*A[i] + 1; for (int i = 0; i \u003c 5; i++) B[i] = A[5 - i] - i; In the code above the two loops can be merged into one, becoming:\n1 2 3 4 for (int i = 0; i \u003c 5; i++){ A[i] = 2*A[i] + 1; B[5 - i] = A[i] - 5 + i ; } The new loop requires less time to execute since it can better exploit the pipeline functionality of the processor and can also be further optimized.\nNotice that, on average polyhedral compilation helps the code to obtain a significant speed up, but in some cases can also decrease the performance of the original code.\nDefinitions Now we define the objects needed to create the mathematical model on which different operations can be performed to optimize the loop.\nStatic Control Parts (SCoP) SCoPs are defined as a set of consecutive statements in loop nests with affine bounds and conditional expressions. To be fair, some restriction needs to be included in this definition, like, no function call in a SCoP, only affine access to memory, etc.; otherwise, we cannot characterize the iteration domain of the loop statically.\nWe skip some of those details, and we will only use code that respects that definition, besides this is only a post to get the hang of this technique.\nExample 1 of SCoP: 1 2 3 4 5 for (int i = 0; i \u003c N; i++){ for (int j = 0; j \u003c M; j++){ A[i][j] = i+j; } } The SCoP of this code is given by only one statement: S1: A[i][j] = i + j .\nExample 2 of SCoP: 1 2 3 4 5 6 7 8 9 for (int i = 0; i \u003c N; i++) A[i] = 0; for (int i = 0; i \u003c N; i++){ A[i] = i; for (int j = 0; j \u003c M; j++){ B[j] = A[i] - j; } } The SCoP of this code is given by the statements:\nS1: A[i] = 0 S2: A[i] = i S3: B[j] = A[i] - j Iteration Domain One of the first mathematical objects needed to describe the polyhedral model is the iteration domain. The iteration domain is a set generated by the statement instances. A statement instance is the execution of a statement exactly once and the set of all the instances can be seen as the ’execution space’ of the loop.\nLet’s take for example:\n1 2 3 for (int i = 0; i \u003c N; i++){ A[i] = i; } The instance for i = 0 of statment S1: A[i] = i is \\( S_1(0) = 0 \\), for i = 5 we have \\( S_1(5) = 5 \\) and so on.\nWhat about nested loop? The same:\n1 2 3 4 5 for (int i = 0; i \u003c N; i++){ for(int j = 0; j \u003cN; j++){ A[i][j] = i + j; } } In this case for statment S1: A[i][j] = i + j and i = 5 , j = 2 we have\n$$ S_1 \\left( \\begin{smallmatrix} i \\\\ j \\end{smallmatrix} \\right) = S_1 \\left( \\begin{smallmatrix} 5 \\\\ 2 \\end{smallmatrix} \\right) = 5 + 2 = 7 $$ where the vector \\(\\vec{i_s} = \\left( \\begin{smallmatrix} i \\\\ j \\end{smallmatrix} \\right)\\) is called iteration vector.\nOf course, we cannot precompute all the instances since we don’t know how many they are, and in general, we also don’t know the results. That’s why a more formal definition of the iteration domain can be useful: $$ \\mathscr{D}_s\\left(\\vec{p}\\right) = \\left\\{() \\rightarrow \\vec{i_s} \\in \\mathbb{Z}^{dim(\\vec{i_s})} \\middle| \\left[D_s\\right] \\begin{pmatrix} \\vec{i_s} \\\\ \\vec{p} \\\\ 1 \\end{pmatrix} \\geq \\vec{0} \\right\\} $$ where \\(D_s \\in \\mathbb{Z}^{ m_D \\times \\left( dim(\\vec{i_s}) + dim(\\vec{p}) + 1 \\right) }\\) is an integer matrix, \\(m_D\\) is the number of contraints and \\(\\vec{p}\\) is the vector of parameters.\nFor example, the code:\n1 2 3 4 5 for (int i = 0; i \u003c N; i++){ for (int j = 0; j \u003c M; j++){ A[i][j] = i+j; } } will have as domain:\n$$ \\mathscr{D}_s\\left(N,M\\right) = \\left\\{() \\rightarrow {i \\choose j} \\in \\mathbb{Z}^{2} \\middle| \\begin{bmatrix} 1 \u0026 0 \u0026 0 \u0026 0 \u0026 0 \\\\ 0 \u0026 1 \u0026 0 \u0026 0 \u0026 0 \\\\ -1 \u0026 0 \u0026 1 \u0026 0 \u0026 -1 \\\\ 0 \u0026 -1 \u0026 0 \u0026 1 \u0026 -1 \\end{bmatrix} \\begin{pmatrix} i \\\\ j \\\\ N \\\\ M \\\\ 1 \\end{pmatrix} \\geq \\vec{0} \\right\\} $$\nThe numbers in the matrix \\(D_s\\) represent the coefficients of the variables that define the iteration domain. If we compute the matrix-vector multiplication, we get: $$ \\begin{pmatrix} i \\\\ j \\\\ -i + N - 1\\\\ -j + M - 1 \\\\ 1 \\end{pmatrix} \\geq \\vec{0} \\implies \\begin{pmatrix} i \\\\ j \\\\ N - 1\\\\ M - 1 \\\\ 1 \\end{pmatrix} \\geq \\begin{pmatrix} 0 \\\\ 0 \\\\ i \\\\ j \\\\ 1 \\end{pmatrix} $$\nthat is the set of all ‘boundiers’ of our domain.\\\nGraphically you have: To show that local variables can be used and an iteration domain can be unions of basic relations, e.g., when a condition in the input code splits the iteration domain into a union of disjoint polyhedra, the next example can be useful.\n1 2 3 4 5 6 7 8 for (int i = 0; i \u003c 2 * N; i += 2){ for(int j = i; j \u003c M; j++){ if( i == j || i == 0) A[i][j] = i + j; else A[i][j] = -1; } } $$ \\mathscr{D}_{s_1}\\left(N,M\\right) = \\left\\{() \\rightarrow {i \\choose j} \\in \\mathbb{Z}^{2} \\middle| \\begin{bmatrix} 1 \u0026 0 \u0026 0 \u0026 0 \u0026 0 \\\\ 0 \u0026 1 \u0026 0 \u0026 0 \u0026 0 \\\\ -1 \u0026 0 \u0026 1 \u0026 0 \u0026 -1 \\\\ 0 \u0026 -1 \u0026 0 \u0026 1 \u0026 -1 \\end{bmatrix} \\begin{pmatrix} i \\\\ j \\\\ N \\\\ M \\\\ 1 \\end{pmatrix} \\geq \\vec{0} \\right\\} $$\n$$ \\mathscr{D}_{s_2}\\left(N,M\\right) = \\left\\{() \\rightarrow {i \\choose j} \\in \\mathbb{Z}^{2} \\middle| \\begin{bmatrix} 1 \u0026 0 \u0026 0 \u0026 0 \u0026 0 \\\\ 0 \u0026 1 \u0026 0 \u0026 0 \u0026 0 \\\\ -1 \u0026 0 \u0026 1 \u0026 0 \u0026 -1 \\\\ 0 \u0026 -1 \u0026 0 \u0026 1 \u0026 -1 \\end{bmatrix} \\begin{pmatrix} i \\\\ j \\\\ N \\\\ M \\\\ 1 \\end{pmatrix} \\geq \\vec{0} \\right\\} $$ In this case the iteration domain is given by: $$ \\mathscr{D}_s\\left(N,M\\right) = \\mathscr{D}_2 \\left( N,M\\right) \\bigcup \\mathscr{D}_1 \\left( N,M\\right) $$\nMapping Relations We just briefly saw the concept of iteration domains, but we can notice that it does not contain any information about the execution order of the statements instances. This is why we need another object to describe it. Usually to scheudle the statements instances for a given statement \\(S\\), \\(\\Theta_s\\) is used. For example:\n1 2 3 S1: x = a - c S2: y = d * x S3: z = f/b The first two statements cannot be executed ad the same time since \\(S_2\\) needs to wait for \\(S_1\\) to compute x. On the other hand, \\(S_3\\) can be parallelized. The schedule function for the code above would be: $$ \\begin{align*} \\Theta_{S_1}\u0026=\\{() \\rightarrow (1)\\} \\\\ \\Theta_{S_2}\u0026=\\{() \\rightarrow (2)\\} \\\\ \\Theta_{S_3}\u0026=\\{() \\rightarrow (1)\\} \\end{align*} $$\nThe numbers on the right of the arrow represent the time (or the date) at which the statement can be executed. Those values can have more than one dimension and usually follow a lexicographic order. Like always, a more formal definition is always helpful, so now we have:\n$$ \\Theta_S\\left(\\vec{p}\\right) = \\left\\{\\vec{i_S} \\rightarrow \\vec{t_S} \\in \\mathbb{Z}^{dim(\\vec{i_S})} \\times \\mathbb{Z}^{dim(\\vec{t_S})} \\middle| \\left[T_s\\right] \\begin{pmatrix} \\vec{t_S} \\\\ \\vec{i_S} \\\\ \\vec{p} \\\\ 1 \\end{pmatrix} \\geq \\vec{0} \\right\\} $$\nwhere \\(\\vec{i_S}\\) is the iteration vector and \\(T_S \\in \\mathbb{Z}^{m_{\\Theta_S}\\times (dim(\\vec{i_S}) +\\vec{t_S} +\\vec{p} + 1)} \\) is an integer matrix and \\(m_{\\Theta_S}\\) is the number of contraitns. There are multiple functions that can encode the relation \\(\\vec{i_S} \\rightarrow \\vec{t_S}\\). One way is to create an abstract syntax tree of the program in which: each node is a loop, statements are leaves and arcs connect loops with their internal loops and statements. The labels tell the order of loops or statements in the code. Now as usual, let’s see an example:\n1 2 3 4 for(int i = 0; i \u003c N; i++){ S1: a[i] = 1 \u003c\u003c i; S2: b[i] = a[i] + 1; } The associate Abstract Tree is: According to the Tree above the scheduling relation is: $$ \\Theta_{S_1}\\left(N\\right) = \\left\\{(i) \\rightarrow \\begin{pmatrix} \\vec{t}^1_{S_1} \\\\ \\vec{t}^2_{S_1} \\\\ \\vec{t}^3_{S_1} \\\\ \\vec{t}^4_{S_2} \\\\ \\end{pmatrix} \\in \\mathbb{Z} \\times \\mathbb{Z}^{4} \\middle| \\left[ \\begin{matrix} -1 \u0026 0 \u0026 0 \u0026 0 \u0026 0 \u0026 0 \u0026 0\\\\ 0 \u0026 -1 \u0026 0 \u0026 0 \u0026 1 \u0026 0 \u0026 0\\\\ 0 \u0026 0 \u0026 -1 \u0026 0 \u0026 0 \u0026 0 \u0026 0\\\\ 0 \u0026 0 \u0026 0 \u0026 -1 \u0026 0 \u0026 0 \u0026 1\\\\ \\end{matrix} \\right] \\begin{pmatrix} \\vec{t}^1_{S_1} \\\\ \\vec{t}^2_{S_1} \\\\ \\vec{t}^3_{S_1} \\\\ \\vec{t}^4_{S_2} \\\\ i \\\\ N \\\\ 1 \\end{pmatrix} = \\vec{0} \\right\\} $$\nwhich is \\( \\Theta_{S_1}\\left(N\\right) = \\begin{pmatrix} 0 \\\\ i \\\\ 0 \\\\ 1 \\\\ \\end{pmatrix} \\)\nMemory Accesses Relations Our polyhedral model needs yet another key mathematical object to be able to describe the relations between memory access.\n$$ \\mathcal{A_{S,r}}\\left(\\vec{p}\\right) = \\left\\{\\vec{i_S} \\rightarrow \\vec{a_{S,r}} \\in \\mathbb{Z}^{dim(\\vec{i_S})} \\times \\mathbb{Z}^{dim(\\vec{a_{S,r}})} \\middle| \\left[A_{S,r}\\right] \\begin{pmatrix} \\vec{a_{S,r}} \\\\ \\vec{i_S} \\\\ \\vec{p} \\\\ 1 \\end{pmatrix} \\geq \\vec{0} \\right\\} $$\nwhere \\(r\\) is the reference number associate to the statement \\(S\\), \\(\\vec{i_S}\\) is the iteration vector, \\(\\vec{a_{S,r}}\\) is the access vector and \\( A_{S,r} \\in \\mathbb{Z}^{m_{A_{S,r}} \\times (dim(\\vec{i_S})+dim(\\vec{a_{S,r}})+dim(\\vec{p})+1)} \\) is an integer matrix and \\(m_{A_{S,r}}\\) is the number of constraints.\nFor example:\n1 2 3 for(int i = 0; i \u003c N; i++){ a[i + 1] = i; } generates the following Access relation:\n$$ \\mathcal{A_{S_1,1}}\\left(N\\right) = \\left\\{(i) \\rightarrow \\vec{a_{S_1,1}} \\in \\mathbb{Z} \\times \\mathbb{Z} \\middle| \\left[ \\begin{matrix} -1 \u0026 1 \u0026 0 \u0026 1 \\\\ \\end{matrix} \\right] \\begin{pmatrix} \\vec{a_{S_1,1}} \\\\ i \\\\ N \\\\ 1 \\end{pmatrix} = \\vec{0} \\right\\} $$\nConclusion Hopefully, with this, you should have a rough understanding of what each object is abstracting and how to generate them. All those definitions can be found in Cedric Bastoul Ph.D. thesis. I’ve only added some different examples and left out some details :). In the next post, I’ll try to describe the operations that can be done with those objects.\nReferences http://icps.u-strasbg.fr/~bastoul/research/papers/Bastoul_HDR.pdf https://joelburget.com/polycomp-tutorial-v0.02.pdf http://web.cs.ucla.edu/~pouchet/lectures/888.11.lect1.html https://www.cs.colostate.edu/~cs560/Spring2011/Notes/FeautrierEDFAijpp91.pdf http://web.cs.ucla.edu/~pouchet/lectures/doc/888.11.3.pdf https://www.csa.iisc.ac.in/~udayb/publications/uday-thesis.pdf https://www.cse.iitk.ac.in/users/swarnendu/courses/autumn2020-cs610/intro-to-polyhedral-model.pdf http://icps.u-strasbg.fr/~bastoul/research/papers/BCGST03-LCPC.pdf https://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.129.6227\u0026rep=rep1\u0026type=pdf http://web.cse.ohio-state.edu/~pouchet.2/software/polyopt/doc/htmltexinfo/Specifics-of-Polyhedral-Programs.html https://www.es.ele.tue.nl/~rjordans/5LIM0/10-polyhedral-model.pdf ","wordCount":"1859","inLanguage":"en","datePublished":"2022-04-16T14:36:47+02:00","dateModified":"2022-04-16T14:36:47+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://anzenlabs.com/posts/2022/poly/intro/"},"publisher":{"@type":"Organization","name":"Anzen Labs","logo":{"@type":"ImageObject","url":"https://anzenlabs.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://anzenlabs.com accesskey=h title="Anzen Labs (Alt + H)">Anzen Labs</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://anzenlabs.com/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://anzenlabs.com/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Getting the hang of polyhedral compilation</h1><div class=post-meta><span title='2022-04-16 14:36:47 +0200 +0200'>April 16, 2022</span>&nbsp;·&nbsp;9 min</div></header><div class=post-content><p><em>The polyhedral model</em> is an optimization and parallelization technique used to speed up the execution of <strong>loops</strong>. The main idea is to create a mathematical abstraction of a program and use it to exploit the target device&rsquo;s architecture through the design of sophisticated optimization heuristics. It&rsquo;s called polyhedral compilation, but modeling through polyhedra is neither required nor sufficient, in fact it is possible to obtain the same optimizations with other techniques.</p><h3 id=case-study>Case study<a hidden class=anchor aria-hidden=true href=#case-study>#</a></h3><p>Before defining some common concepts, it&rsquo;s probably better to provide a simple example that shows at least one use case of this technique.</p><p>Let&rsquo;s take the following code as example:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>5</span>; i<span style=color:#f92672>++</span>)
</span></span><span style=display:flex><span>    A[i] <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>*</span>A[i] <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>5</span>; i<span style=color:#f92672>++</span>)
</span></span><span style=display:flex><span>    B[i] <span style=color:#f92672>=</span> A[<span style=color:#ae81ff>5</span> <span style=color:#f92672>-</span> i] <span style=color:#f92672>-</span> i;
</span></span></code></pre></td></tr></table></div></div><p>In the code above the two loops can be merged into one, becoming:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>5</span>; i<span style=color:#f92672>++</span>){
</span></span><span style=display:flex><span>    A[i] <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>*</span>A[i] <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    B[<span style=color:#ae81ff>5</span> <span style=color:#f92672>-</span> i] <span style=color:#f92672>=</span> A[i] <span style=color:#f92672>-</span> <span style=color:#ae81ff>5</span> <span style=color:#f92672>+</span> i ;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>The new loop requires less time to execute since it can better exploit the pipeline functionality of the processor and can also be further optimized.</p><p><em>Notice that, on average polyhedral compilation helps the code to obtain a significant speed up, but in some cases can also decrease the performance of the original code.</em></p><h2 id=definitions>Definitions<a hidden class=anchor aria-hidden=true href=#definitions>#</a></h2><p>Now we define the objects needed to create the mathematical model on which different operations can be performed to optimize the loop.</p><h3 id=static-control-parts-scop>Static Control Parts (SCoP)<a hidden class=anchor aria-hidden=true href=#static-control-parts-scop>#</a></h3><p>SCoPs are defined as <em><strong>a set of consecutive statements in loop nests with affine bounds and conditional expressions</strong></em>. To be fair, some restriction needs to be included in this definition, like, <em>no function call in a SCoP</em>, <em>only affine access to memory</em>, etc.; otherwise, we cannot characterize the iteration domain of the loop statically.<br>We skip some of those details, and we will only use code that respects that definition, besides this is only a post to get the hang of this technique.</p><ul><li>Example 1 of SCoP:</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> N; i<span style=color:#f92672>++</span>){
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> j <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; j <span style=color:#f92672>&lt;</span> M; j<span style=color:#f92672>++</span>){
</span></span><span style=display:flex><span>        A[i][j] <span style=color:#f92672>=</span> i<span style=color:#f92672>+</span>j;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>The <code>SCoP</code> of this code is given by only one statement: <code>S1: A[i][j] = i + j </code>.</p><ul><li>Example 2 of SCoP:</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> N; i<span style=color:#f92672>++</span>)
</span></span><span style=display:flex><span>    A[i] <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> N; i<span style=color:#f92672>++</span>){
</span></span><span style=display:flex><span>    A[i] <span style=color:#f92672>=</span> i;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> j <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; j <span style=color:#f92672>&lt;</span> M; j<span style=color:#f92672>++</span>){
</span></span><span style=display:flex><span>        B[j] <span style=color:#f92672>=</span> A[i] <span style=color:#f92672>-</span> j;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>The <code>SCoP</code> of this code is given by the statements:</p><ul><li><code>S1: A[i] = 0</code></li><li><code>S2: A[i] = i</code></li><li><code>S3: B[j] = A[i] - j</code></li></ul><h3 id=iteration-domain>Iteration Domain<a hidden class=anchor aria-hidden=true href=#iteration-domain>#</a></h3><p>One of the first mathematical objects needed to describe the polyhedral model is the <strong>iteration domain</strong>. The iteration domain is a set generated by the <em>statement instances</em>.
A <em>statement instance</em> is the execution of a statement exactly once and the set of all the instances can be seen as the &rsquo;execution space&rsquo; of the loop.</p><p><img loading=lazy src=/xkcd_godel.png#center alt=xkcd></p><p>Let&rsquo;s take for example:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> N; i<span style=color:#f92672>++</span>){
</span></span><span style=display:flex><span>    A[i] <span style=color:#f92672>=</span> i;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>The instance for <code>i = 0</code> of statment <code>S1: A[i] = i</code> is \( S_1(0) = 0 \), for <code>i = 5</code> we have \( S_1(5) = 5 \) and so on.<br>What about nested loop? The same:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> N; i<span style=color:#f92672>++</span>){
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span>(<span style=color:#66d9ef>int</span> j <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; j <span style=color:#f92672>&lt;</span>N; j<span style=color:#f92672>++</span>){
</span></span><span style=display:flex><span>        A[i][j] <span style=color:#f92672>=</span> i <span style=color:#f92672>+</span> j;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>In this case for statment <code>S1: A[i][j] = i + j</code> and <code>i = 5</code> , <code>j = 2</code> we have</p><p>$$
S_1 \left(
\begin{smallmatrix}
i \\
j
\end{smallmatrix}
\right) = S_1 \left(
\begin{smallmatrix}
5 \\
2
\end{smallmatrix}
\right) = 5 + 2 = 7
$$
where the vector \(\vec{i_s} = \left( \begin{smallmatrix} i \\ j \end{smallmatrix} \right)\) is called <em>iteration vector</em>.<br><br>Of course, we cannot precompute all the instances since we don&rsquo;t know how many they are, and in general, we also don&rsquo;t know the results. That&rsquo;s why a more formal definition of the <em>iteration domain</em> can be useful:
$$
\mathscr{D}_s\left(\vec{p}\right) = \left\{() \rightarrow \vec{i_s} \in \mathbb{Z}^{dim(\vec{i_s})} \middle| \left[D_s\right]
\begin{pmatrix}
\vec{i_s} \\
\vec{p} \\
1
\end{pmatrix}
\geq \vec{0}
\right\}
$$
where \(D_s \in \mathbb{Z}^{ m_D \times \left( dim(\vec{i_s}) + dim(\vec{p}) + 1 \right) }\) is an integer matrix, \(m_D\) is the number of contraints and \(\vec{p}\) is the <em>vector of parameters</em>.</p><p>For example, the code:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> N; i<span style=color:#f92672>++</span>){
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> j <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; j <span style=color:#f92672>&lt;</span> M; j<span style=color:#f92672>++</span>){
</span></span><span style=display:flex><span>        A[i][j] <span style=color:#f92672>=</span> i<span style=color:#f92672>+</span>j;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>will have as domain:</p><p>$$
\mathscr{D}_s\left(N,M\right) = \left\{() \rightarrow {i \choose j} \in \mathbb{Z}^{2} \middle|
\begin{bmatrix}
1 & 0 & 0 & 0 & 0 \\
0 & 1 & 0 & 0 & 0 \\
-1 & 0 & 1 & 0 & -1 \\
0 & -1 & 0 & 1 & -1
\end{bmatrix}
\begin{pmatrix}
i \\
j \\
N \\
M \\
1
\end{pmatrix}
\geq \vec{0}
\right\}
$$</p><p>The numbers in the matrix \(D_s\) represent the coefficients of the variables that define the iteration domain. If we compute the matrix-vector multiplication, we get:
$$
\begin{pmatrix}
i \\
j \\
-i + N - 1\\
-j + M - 1 \\
1
\end{pmatrix}
\geq \vec{0}
\implies
\begin{pmatrix}
i \\
j \\
N - 1\\
M - 1 \\
1
\end{pmatrix}
\geq
\begin{pmatrix}
0 \\
0 \\
i \\
j \\
1
\end{pmatrix}
$$</p><p>that is the set of all &lsquo;boundiers&rsquo; of our domain.\</p><h4 id=graphically-you-have>Graphically you have:<a hidden class=anchor aria-hidden=true href=#graphically-you-have>#</a></h4><figure><img loading=lazy src=/itdomain.svg#center alt=dwarf width=600px></figure><p>To show that local variables can be used and an iteration domain can be unions of basic relations, e.g., when a condition in the input code splits the iteration domain into a union of disjoint polyhedra, the next example can be useful.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>*</span> N; i <span style=color:#f92672>+=</span> <span style=color:#ae81ff>2</span>){
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span>(<span style=color:#66d9ef>int</span> j <span style=color:#f92672>=</span> i; j <span style=color:#f92672>&lt;</span> M; j<span style=color:#f92672>++</span>){
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>( i <span style=color:#f92672>==</span> j <span style=color:#f92672>||</span> i <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>            A[i][j] <span style=color:#f92672>=</span> i <span style=color:#f92672>+</span> j;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>            A[i][j] <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>$$
\mathscr{D}_{s_1}\left(N,M\right) = \left\{() \rightarrow {i \choose j} \in \mathbb{Z}^{2} \middle|
\begin{bmatrix}
1 & 0 & 0 & 0 & 0 \\
0 & 1 & 0 & 0 & 0 \\
-1 & 0 & 1 & 0 & -1 \\
0 & -1 & 0 & 1 & -1
\end{bmatrix}
\begin{pmatrix}
i \\
j \\
N \\
M \\
1
\end{pmatrix}
\geq \vec{0}
\right\}
$$</p><p>$$
\mathscr{D}_{s_2}\left(N,M\right) = \left\{() \rightarrow {i \choose j} \in \mathbb{Z}^{2} \middle|
\begin{bmatrix}
1 & 0 & 0 & 0 & 0 \\
0 & 1 & 0 & 0 & 0 \\
-1 & 0 & 1 & 0 & -1 \\
0 & -1 & 0 & 1 & -1
\end{bmatrix}
\begin{pmatrix}
i \\
j \\
N \\
M \\
1
\end{pmatrix}
\geq \vec{0}
\right\}
$$
In this case the iteration domain is given by:
$$
\mathscr{D}_s\left(N,M\right) = \mathscr{D}_2 \left( N,M\right) \bigcup \mathscr{D}_1 \left( N,M\right)
$$</p><h3 id=mapping-relations>Mapping Relations<a hidden class=anchor aria-hidden=true href=#mapping-relations>#</a></h3><p>We just briefly saw the concept of iteration domains, but we can notice that it does not contain any information about the execution order of the statements instances. This is why we need another object to describe it.
Usually to scheudle the statements instances for a given statement \(S\), \(\Theta_s\) is used.
For example:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>S1: x <span style=color:#f92672>=</span> a <span style=color:#f92672>-</span> c
</span></span><span style=display:flex><span>S2: y <span style=color:#f92672>=</span> d <span style=color:#f92672>*</span> x
</span></span><span style=display:flex><span>S3: z <span style=color:#f92672>=</span> f<span style=color:#f92672>/</span>b
</span></span></code></pre></td></tr></table></div></div><p>The first two statements cannot be executed ad the same time since \(S_2\) needs to wait for \(S_1\) to compute <code>x</code>. On the other hand, \(S_3\) can be parallelized.
The schedule function for the code above would be:
$$
\begin{align*}
\Theta_{S_1}&=\{() \rightarrow (1)\} \\
\Theta_{S_2}&=\{() \rightarrow (2)\} \\
\Theta_{S_3}&=\{() \rightarrow (1)\}
\end{align*}
$$</p><p>The numbers on the right of the arrow represent the time (or the date) at which the statement can be executed. Those values can have more than one dimension and usually follow a <em>lexicographic</em> order.
Like always, a more formal definition is always helpful, so now we have:</p><p>$$
\Theta_S\left(\vec{p}\right) = \left\{\vec{i_S} \rightarrow \vec{t_S} \in \mathbb{Z}^{dim(\vec{i_S})} \times \mathbb{Z}^{dim(\vec{t_S})} \middle| \left[T_s\right]
\begin{pmatrix}
\vec{t_S} \\
\vec{i_S} \\
\vec{p} \\
1
\end{pmatrix}
\geq \vec{0}
\right\}
$$</p><p>where \(\vec{i_S}\) is the iteration vector and \(T_S \in \mathbb{Z}^{m_{\Theta_S}\times (dim(\vec{i_S}) +\vec{t_S} +\vec{p} + 1)} \) is an integer matrix and \(m_{\Theta_S}\) is the number of contraitns.
There are multiple functions that can encode the relation \(\vec{i_S} \rightarrow \vec{t_S}\). One way is to create an abstract syntax tree of the program in which: each node is a loop, statements are leaves and arcs connect loops with their internal loops and statements. The labels tell the order of loops or statements in the code.
Now as usual, let&rsquo;s see an example:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>for</span>(<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> N; i<span style=color:#f92672>++</span>){
</span></span><span style=display:flex><span>  S1:  a[i] <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>&lt;&lt;</span> i;
</span></span><span style=display:flex><span>  S2:  b[i] <span style=color:#f92672>=</span> a[i] <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>The associate Abstract Tree is:
<img loading=lazy src=/abt.svg#center alt=abt></p><p>According to the Tree above the scheduling relation is:
$$
\Theta_{S_1}\left(N\right) = \left\{(i) \rightarrow
\begin{pmatrix}
\vec{t}^1_{S_1} \\
\vec{t}^2_{S_1} \\
\vec{t}^3_{S_1} \\
\vec{t}^4_{S_2} \\
\end{pmatrix}
\in \mathbb{Z} \times \mathbb{Z}^{4} \middle|
\left[
\begin{matrix}
-1 & 0 & 0 & 0 & 0 & 0 & 0\\
0 & -1 & 0 & 0 & 1 & 0 & 0\\
0 & 0 & -1 & 0 & 0 & 0 & 0\\
0 & 0 & 0 & -1 & 0 & 0 & 1\\
\end{matrix}
\right]
\begin{pmatrix}
\vec{t}^1_{S_1} \\
\vec{t}^2_{S_1} \\
\vec{t}^3_{S_1} \\
\vec{t}^4_{S_2} \\
i \\
N \\
1
\end{pmatrix}
= \vec{0}
\right\}
$$</p><p>which is \( \Theta_{S_1}\left(N\right) = \begin{pmatrix}
0 \\
i \\
0 \\
1 \\
\end{pmatrix} \)</p><h3 id=memory-accesses-relations>Memory Accesses Relations<a hidden class=anchor aria-hidden=true href=#memory-accesses-relations>#</a></h3><p>Our polyhedral model needs yet another key mathematical object to be able to describe the relations between memory access.</p><p>$$
\mathcal{A_{S,r}}\left(\vec{p}\right) = \left\{\vec{i_S} \rightarrow \vec{a_{S,r}} \in \mathbb{Z}^{dim(\vec{i_S})} \times \mathbb{Z}^{dim(\vec{a_{S,r}})} \middle| \left[A_{S,r}\right]
\begin{pmatrix}
\vec{a_{S,r}} \\
\vec{i_S} \\
\vec{p} \\
1
\end{pmatrix}
\geq \vec{0}
\right\}
$$</p><p>where \(r\) is the reference number associate to the statement \(S\), \(\vec{i_S}\) is the iteration vector, \(\vec{a_{S,r}}\) is the access vector and \( A_{S,r} \in \mathbb{Z}^{m_{A_{S,r}} \times (dim(\vec{i_S})+dim(\vec{a_{S,r}})+dim(\vec{p})+1)} \) is an integer matrix and \(m_{A_{S,r}}\) is the number of constraints.</p><p>For example:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>for</span>(<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> N; i<span style=color:#f92672>++</span>){
</span></span><span style=display:flex><span>    a[i <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>] <span style=color:#f92672>=</span> i;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>generates the following Access relation:</p><p>$$
\mathcal{A_{S_1,1}}\left(N\right) = \left\{(i) \rightarrow \vec{a_{S_1,1}} \in \mathbb{Z} \times \mathbb{Z} \middle| \left[
\begin{matrix}
-1 & 1 & 0 & 1 \\
\end{matrix}
\right]
\begin{pmatrix}
\vec{a_{S_1,1}} \\
i \\
N \\
1
\end{pmatrix}
= \vec{0}
\right\}
$$</p><h3 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h3><p>Hopefully, with this, you should have a rough understanding of what each object is abstracting and how to generate them. All those definitions can be found in Cedric Bastoul Ph.D. thesis. I&rsquo;ve only added some different examples and left out some details :).
In the next post, I&rsquo;ll try to describe the operations that can be done with those objects.</p><h2 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h2><ul><li><a href=http://icps.u-strasbg.fr/~bastoul/research/papers/Bastoul_HDR.pdf>http://icps.u-strasbg.fr/~bastoul/research/papers/Bastoul_HDR.pdf</a></li><li><a href=https://joelburget.com/polycomp-tutorial-v0.02.pdf>https://joelburget.com/polycomp-tutorial-v0.02.pdf</a></li><li><a href=http://web.cs.ucla.edu/~pouchet/lectures/888.11.lect1.html>http://web.cs.ucla.edu/~pouchet/lectures/888.11.lect1.html</a></li><li><a href=https://www.cs.colostate.edu/~cs560/Spring2011/Notes/FeautrierEDFAijpp91.pdf>https://www.cs.colostate.edu/~cs560/Spring2011/Notes/FeautrierEDFAijpp91.pdf</a></li><li><a href=http://web.cs.ucla.edu/~pouchet/lectures/doc/888.11.3.pdf>http://web.cs.ucla.edu/~pouchet/lectures/doc/888.11.3.pdf</a></li><li><a href=https://www.csa.iisc.ac.in/~udayb/publications/uday-thesis.pdf>https://www.csa.iisc.ac.in/~udayb/publications/uday-thesis.pdf</a></li><li><a href=https://www.cse.iitk.ac.in/users/swarnendu/courses/autumn2020-cs610/intro-to-polyhedral-model.pdf>https://www.cse.iitk.ac.in/users/swarnendu/courses/autumn2020-cs610/intro-to-polyhedral-model.pdf</a></li><li><a href=http://icps.u-strasbg.fr/~bastoul/research/papers/BCGST03-LCPC.pdf>http://icps.u-strasbg.fr/~bastoul/research/papers/BCGST03-LCPC.pdf</a></li><li><a href="https://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.129.6227&rep=rep1&type=pdf">https://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.129.6227&rep=rep1&type=pdf</a></li><li><a href=http://web.cse.ohio-state.edu/~pouchet.2/software/polyopt/doc/htmltexinfo/Specifics-of-Polyhedral-Programs.html>http://web.cse.ohio-state.edu/~pouchet.2/software/polyopt/doc/htmltexinfo/Specifics-of-Polyhedral-Programs.html</a></li><li><a href=https://www.es.ele.tue.nl/~rjordans/5LIM0/10-polyhedral-model.pdf>https://www.es.ele.tue.nl/~rjordans/5LIM0/10-polyhedral-model.pdf</a></li></ul></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://anzenlabs.com>Anzen Labs</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>